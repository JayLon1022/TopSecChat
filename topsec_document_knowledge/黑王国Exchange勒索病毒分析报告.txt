黑王国针对Exchange勒索病毒样本的分析

病毒概述  
近日，天融信EDR安全团队捕获了一个病毒样本。黑客利用社工手段诱骗受害者点击下载文件，点击后获取操作系统信息，并尝试将信息发送到黑客服务器。如果发送信息失败，病毒则继续进行加密。其生成随机秘钥，在每个目录下释放勒索信，并用0x00填充文件内容以对齐为16的倍数，采用AES方式加密文件内容，最后生成勒索信。本次分析的病毒与上次的病毒代码功能一致，但开始出现了干扰分析的垃圾代码，并使用公用的云存储增加溯源难度。同时，新加入了钩子功能，阻止用户使用鼠标和键盘，并针对数据库的功能进行了历史记录清理。天融信EDR能够精确检测并查杀该木马，有效阻止事件蔓延。

病毒分析  
收到样本后，用侦壳软件打开，发现没有壳。查看文件熵值后，判断可能存在加密数据。进一步检查文件，疑似调用python37.dll，推测可能为Python打包程序。

将exe解压为pyc文件，接着将pyc文件转换为py文件，读取病毒代码进行分析。尝试通过POST方式向mega.io发起连接请求，并调用PowerShell停止数据库服务，清理历史记录。

建立被勒索的名单目录，生成秘钥和被勒索的ID，并进行文件加密模块。

使用AES的CBC模式进行加密，将加密后的文件回写。经过20分钟后，锁定键盘和鼠标，建立钩子以禁止使用鼠标和键盘，生成随机后缀名，并发送数据，包括时间、受害人ID、秘钥、用户名等信息。

清理痕迹和勒索信内容。

防护建议  
针对该病毒，可通过以下三种方式进行防御或查杀：  
1. 下载安装天融信EDR防御软件，并进行全盘扫描查杀，以清除该木马。  
2. 更改系统及应用使用的默认密码，配置高强度密码认证，并定期更新密码。  
3. 及时修复系统及应用漏洞。

天融信EDR获取方式  
- 天融信EDR企业版试用：可通过天融信各地分公司获取（查询网址：http://www.topsec.com.cn/contact/）  
- 天融信EDR单机版下载地址：http://edr.topsec.com.cn