针对于巴克莱银行宏病毒样本分析

病毒概述  
近日，天融信EDR安全团队捕获了一个病毒样本。黑客为了防止静态分析，采用鼠标移动后触发病毒运行，尝试绕过AMSI，将内容放置于组件中。读取文件内容后，使用base64解密和RC4解密，获取系统进程explorer的PID，并指定为父进程，建立iexplorer.exe进程。在将进程设置为傀儡进程后，将shellcode注入该进程中，最终连接到黑客后台。天融信EDR能够精准检测并查杀该木马，有效阻止事件蔓延。

病毒分析  
收到样本后，打开发现有宏内容。经过分析，发现宏文件经过加密。绕过加密后，找到宏的主函数，在鼠标移动时运行X32_office函数，尝试绕过AMSI。如果成功绕过，将执行CallMe函数，读取组件内容并进行base64解密，加载内置的密钥utbyyggruw进行RC4解密。

读取explorer的PID，并指定为病毒的父进程。为了后续分析的方便，将shellcode转储到桌面。建立iexplorer.exe的进程，利用傀儡进程技术，将病毒代码注入正常的系统进程中。病毒运行成功后，弹出框提示解密失败，并要求联系黑客。

查看之前保存的shellcode。

运行解密cs shellcode的脚本，获取连接黑客后台的地址及端口号。

防护建议  
针对该病毒，可通过以下三种方式进行防御或查杀：  
1. 下载安装天融信EDR防御软件并进行全盘扫描查杀，以清除该木马。  
2. 更改系统及应用使用的默认密码，配置高强度密码认证，并定期更新密码。  
3. 及时修复系统及应用漏洞。

天融信EDR获取方式  
- 天融信EDR企业版试用：可通过天融信各地分公司获取（查询网址：http://www.topsec.com.cn/contact/）  
- 天融信EDR单机版下载地址：http://edr.topsec.com.cn