天融信DarkSide勒索软件攻击事件分析

事件概况  
DarkSide首次出现在2020年8月，是勒索软件团伙的新兴代表。该组织采用勒索软件即服务（RaaS）模型进行各种犯罪活动，专门针对有能力支付高额赎金的企业进行攻击，既加密数据又窃取信息，并威胁如果不支付赎金就将数据公开。

原理简述  
DarkSide通常会尝试控制Windows AD域控制器，以实现整个AD域的横向渗透，方便盗取数据和批量释放勒索软件。DarkSide使用Salsa20和RSA进行文件加密，采用Salsa20加密文件，并用RSA加密Salsa20密钥，加密完成后会显示勒索信息，并通过HTTPS协议回传信息。天融信天璇实验室对DarkSide的行为进行了跟踪、研究和分析，并定义了相应的检测防御规则，天融信客户可以通过天融信僵尸网络木马和蠕虫监测与处置系统（TopTVD）进行检测和防护。

感染表现  
1. 在用户目录下生成加密日志文档。  
2. 在C:\ProgramData目录下生成加密图标和勒索图片。  
3. （386、adv、ani、bat、bin、exe等后缀名文件加密，经过加密的文件后缀名为随机字符串。  
4. 在每个加密文件夹路径下生成勒索文档。  
5. 桌面背景更改为勒索提示图片。  

样本分析  
DarkSide使用C/C++编写，通过检查CPU运行时间GetTickCount()进行反调试。主要流程是提升权限后重新启动自身，结束部分进程和服务，搜集系统信息进行加密上传，使用Salsa20算法加密文件，并在每个加密文件夹下生成勒索提示文档，将桌面背景设置为勒索图片。  
1. 动态API解密：使用LoadLibrary和GetProcAddress动态获取所需的API函数。  
2. 在内存中解密配置文件，主要内容包括：加密过程中排除的文件、文件夹，加密后缀，要结束的进程和服务，C2地址，威胁字符串和文本内容。  
3. 检查系统语言，跳过俄文。  
4. 检查系统权限是否为管理员权限，通过联合判断操作系统版本是否为Vista及以上，如果不是管理员权限，会检查用户令牌信息是否具备SECURITY_BUILTIN_DOMAIN_RID和DOMAIN_ALIAS_RID_ADMINS权限。  
5. 更新权限后使用CreateProcessAsUserW重新启动勒索软件。  
6. 检查用户是否有NTAUTHORITY权限。  

最后，恶意软件将版本信息和受害者的UID包含在系统信息中，最终内容为：  
8. 连接C2服务器加密上传。通过InternetOpenW和InternetConnectW打开Firefox/80.0应用程序的句柄，通过端口443连接到C2服务器，C2网址为：baroquetees.com。  
9. 结束指定服务（如vss、sql、svc$等），通过调用OpenSCManagerW打开服务控制管理器，并使用EnumServicesStatusExW枚举要结束的服务列表，通过ControlService和DeleteService调用将其删除。  
10. 结束指定进程（如sql、oracle、firefox等），通过调用NtQuerySystemInformation查询SYSTEM_PROCESS_INFORMATION结构与每一个要结束的进程列表，如果在进程列表中则使用TerminateProcess结束进程。  
11. 通过注册表设置加密图标。  
12. 主要加密函数使用RtlRandomEx产生随机数拼接得到0x40大小字节数据作为初始密钥，每个待加密文件都有唯一的密钥，随后用内置的RSA-1024公钥进行加密，对文件采用Salsa20算法加密完成后，将0x90大小字节数据（被RSA加密后的密钥）写入文件末尾。  
13. 在加密文件夹下生成勒索提示文档。  
14. 通过注册表修改桌面背景图为勒索图片。  
15. 加密完成后会上传信息：加密的用户ID、UID、加密数量和加密大小。  

声明  
1. 本文档所提到的资讯仅供参考，内容可能会随时更新，天融信不另行通知。  
2. 本文档中提到的信息为正常公开的信息，如因本文档或其所提到的任何信息导致他人直接或间接的资料流失、利益损失，天融信及其员工不承担任何责任。