听风者实验室

北京天融信网络安全技术有限公司

文档信息  
文档编号  
关键字 TA505 PDF FlawedAmmyy RAT  
发布日期 2018-08-20  
更新日期 2018-08-26  
分析团队 听风者实验室蓝队  

文档修订  
版本 日期 修改人员 描述 审核人员  
V1.0 2018.08.21 听风者 创建  

版权说明  
本文件中出现的全部内容，除另有特别注明，版权均属北京天融信网络安全技术有限公司所有。任何个人或机构未经北京天融信网络安全技术有限公司书面授权，不得以任何方式复制或引用文件的任何部分。  

保密声明  
本文件包含来自北京天融信网络安全技术有限公司的可靠、权威的信息，以及用户单位信息系统的敏感信息。接受这份文件表示同意对其内容保密，未经北京天融信网络安全技术有限公司书面请求和认可，不得复制、泄露或传播此文件。如果您不是有意接受者，请注意对这份文件内容的任何形式的泄露、复制或传播都是被禁止的。  

目 录  
第1章 事件简述  
1.1 PDF分析  
1.2 分析CAL.EXE恶意程序  
1.2.1 行为分析  
1.2.2 调试分析  
1.2.3 分析资源文件解密出的PE  
1.3 分析WSUS.EXE  
1.3.1 行为监控  
1.3.2 调试分析  
第2章 IOC特征  
第3章 总结  

第1章 事件简述  
著名金融犯罪集团TA505发起了大规模的垃圾邮件活动，使用全新的运营商传播FlawedAmmyy RAT，其中包含恶意的SettingContent-ms文件的PDF文件。  
SettingContent-ms文件格式是Windows 10中引入的，它允许用户为各种Windows 10设置页面创建快捷方式。恶意制作的文件能够绕过特定的Windows 10防御。当然，让受害者打开附加在电子邮件中的文件可能是一个挑战，因此攻击者开始将这些格式插入到看起来更无害的附件中。  
研究人员在6月份发现有人滥用Microsoft Word文档中的SettingContent-ms文件格式。上周，Proofpoint的研究人员观察到这种方法已经发展并扩展到了PDF文档，这是一种以前未知的新技术。  

1.1 PDF分析  
根据PDF文件结构，在010Editor中可以看到包含一个XREF对象，其中对象0中包含加密的数据流。对象3中有JavaScript字符串。使用PdfStreamDumper.exe可以查看PDF文中包含的JavaScript代码并提取出加密的数据流。XREF是交叉引用表，描述每个间接对象的编号、版本和绝对文件位置，以及调用顺序。根据trailer信息，根节点为对象12。  

对象12中的代码会调用JS函数function11()，该函数位于对象2中。打开PDF时会提示是否打开此SettingContent-ms文件。  

从对象0中解密出SettingContent-ms文件。由于服务器地址http://169.239.129.117已经失效，无法下载到cal文件，研究人员根据PDF的MD5值和该域名在VT、ANYRUN等网站进行查询，下载到cal样本继续分析。根据SettingContent-ms中的代码可知，下载到cal后会创建一个进程来执行它。  

1.2 分析cal.exe恶意程序  
文件名称：cal  
文件大小：165664字节  
修改时间：2018年7月13日 00:34:47  
MD5：631FACBFEF5C0199859F019366FCA951  
SHA1：3D34BB015F8B62A348FC087C820D7BCBD33AFE8D  
该恶意程序带有数字签名。  

1.2.1 行为分析  
执行cmd命令，停止并删除ammyy服务和foundation服务。连接网络，抓包网址，删除自身。  

1.2.2 调试分析  
样本首先会检测是否存在指定的反病毒进程，如果存在就结束自身程序。存在一个小的反调试函数，判断是否存在单步异常反调试，在调试状态下会覆盖单步异常。正常运行时产生单步异常进入SEH处理异常。  
调用IsDebuggerPresent函数检测是否在调试状态。之后会从指定资源中拷贝数据并解密，再修复IAT和重定位，最后跳转过去开始执行。解密过程如下：与key数组进行异或。  

1.2.3 分析资源文件解密出的PE  
该PE首先检测系统中是否存在指定的反病毒进程，如果有就结束自身进程。然后获取CreateProcessA的函数地址，从上面读取出第一个字节并判断是否为0xE9，即判断该函数是否被HOOK，如果是就结束自身进程。接着查找系统中是否存在“wsus.exe”进程，如果存在则结束该进程。  
通过哈希值动态获取ShellExecuteW函数地址，清除旧的后门服务，参数“/C”表示执行完cmd命令后关闭窗口，这4条命令依次停止ammyy服务并删除，停止foundation服务并删除。这两个服务是后门联网下载的新程序要创建和启动的服务名称。  
再检测系统中是否存在指定进程，如果检测到会新申请一段内存空间，以挂起的方式创建一个进程，再调用sub_401850函数，函数内把自身的PE数据拷贝到新申请的空间中，执行进一步的操作。  
如果没有找到指定的进程，就通过哈希动态获取LoadLibraryExA地址、wsprintfA地址，拼接出路径“C:\Program Data\Microsoft Help\wsus_%x.DATE0xFFFEEA”，其中%x的值是随机值，为第三个字符串参数的内存地址，因此程序每次运行生成的文件名都是不同的。然后尝试删除该文件。  
接着进行联网，从"http://169.239.129.117/Yjdfel765Hs"下载后门程序。首先动态获取InternetOpenA、InternetOpenUrlA、CreateFileA、InternetCloseHandle等函数的地址，依次调用创建网络连接。如果InternetOpenUrlA执行成功后就调用CreateFileA创建文件，成功创建后调用InternetReadFile从指定IP下载数据，在一个死循环内执行将下载的数据写入文件、再次下载数据的操作。通过第四个参数——实际读取到的字节数来判断数据下载是否到达末尾，如果到达结尾就退出循环，关闭句柄。  
由于http://169.239.129.117已经失效，这里仍从网上找到Yjdfel765Hs文件进行分析。下载成功后会根据下载到的文件大小申请一段内存空间，将文件读入内存，调用wsprintfA拼接出路径字符串“C:\Program Data\Microsoft Help\wsus.exe”，对内存中的数据进行解密，将解密后的数据写入到“C:\Program Data\Microsoft Help\wsus.exe”文件中。  
之后判断解密后的数据头是否为“MZ”，再判断当前用户是否为管理员用户。如果是管理员就创建进程，创建ammyy和foundation服务，并删除自身和cal.exe文件。  

1.3 分析wsus.exe  
FlawedAmmyy后门文件  
文件名称：wsus.exe  
文件大小：669472字节  
修改时间：2018年8月23日 23:28:51  
MD5：C9ED44CFC79C52E12FCF969C78A83AD4  
SHA1：65A3E6F290962D9E620BFFE2B13C21C06FC0486C  
同样具有数字签名。  

1.3.1 行为监控  
通过https连接网络，收到C&C服务端返回0x2D，连接成功，发送主机信息。  

1.3.2 调试分析  
获取资源配置文件，创建线程连接，连接IP，连接失败抛出异常，创建线程继续连接，接收数据为0x2D，连接成功，发送主机信息。根据开机时间随机获取8位用户ID，第一位始终为5，获取主机相关信息，后续根据指令执行其他命令。  

文件中Ammyy Admin的部分功能。  

第2章 IOC特征  
169.239.129.117  
185.99.132.119  
162E98D89F2AE3B4B469B066EBFE02AF22E9B869  
3D34BB015F8B62A348FC087C820D7BCBD33AFE8D  
A7C5982A3FCFB837241E3487DC5D22356771B424  
65A3E6F290962D9E620BFFE2B13C21C06FC0486C  

第3章 总结  
此样本主要利用SettingContent-ms格式文件执行恶意程序。联网下载模块均带有数字签名，检测进程躲避相关杀软。添加服务以system权限运行。联网下载模块和C&C配置加密保存在资源文件。后门基于Ammyy Admin第3版泄露源码制作，功能全面。